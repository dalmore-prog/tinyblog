<!DOCTYPE html>
<html>
<head>
    <title>编辑文章 - <%= settings.site_name %></title>
    <link rel="preconnect" href="https://fonts.loli.net">
    <link rel="preconnect" href="https://gstatic.loli.net" crossorigin>
    <link href="https://fonts.loli.net/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css">
    <link rel="stylesheet" href="/css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
    <style>
        body { overflow: auto; height: auto; } /* Override admin.css lock */
        .editor-container { max-width: 1000px; margin: 40px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* Editor Scroll Support */
        .CodeMirror, .CodeMirror-scroll {
            min-height: 500px;
            max-height: 700px;
        }
        .editor-toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <form action="/admin/article/save" method="POST">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 30px;">
                <h2 style="margin: 0; border: none; padding: 0;"><%= article.id ? '编辑文章' : '新建文章' %></h2>
                <div class="actions">
                    <a href="/admin" class="btn btn-secondary" style="margin-right: 10px;">取消</a>
                    <button type="submit" class="btn btn-success">保存文章</button>
                </div>
            </div>
            
            <input type="hidden" name="id" value="<%= article.id || '' %>">
            
            <div class="form-group">
                <label>文章标题</label>
                <input type="text" name="title" value="<%= article.title || '' %>" required placeholder="请输入文章标题">
            </div>
            
            <div class="form-group">
                <label>摘要 (公开可见)</label>
                <textarea name="summary" rows="3" required placeholder="请输入简短摘要，访客无需付费即可看到"><%= article.summary || '' %></textarea>
            </div>
            
            <div class="form-group" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="hidden" id="hidden" <%= article.hidden ? 'checked' : '' %> style="width: auto; margin: 0;">
                    <label for="hidden" style="margin: 0; cursor: pointer;">隐藏文章 (不在前端首页展示)</label>
                </div>

                <% if (settings.enable_key_verification !== false) { %>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="requiresKey" id="requiresKey" <%= (article.requiresKey !== false) ? 'checked' : '' %> style="width: auto; margin: 0;">
                    <label for="requiresKey" style="margin: 0; cursor: pointer;">卡密保护 (需要卡密才能查看正文)</label>
                </div>
                <% } else { %>
                    <input type="hidden" name="requiresKey" value="<%= article.requiresKey !== false ? 'on' : 'off' %>">
                    <div style="display: flex; align-items: center; gap: 10px; opacity: 0.6;" title="系统全局设置中已关闭卡密验证">
                        <input type="checkbox" disabled checked style="width: auto; margin: 0;">
                        <label style="margin: 0;">卡密保护 (系统已全局关闭)</label>
                    </div>
                <% } %>
            </div>
            
            <div class="form-group">
                <label>正文内容 (付费解锁后可见)</label>
                <textarea id="markdown-editor" name="content"><%= content || '' %></textarea>
            </div>
            
            <div class="actions" style="text-align: right; margin-top: 20px;">
                <a href="/admin" class="btn btn-secondary" style="margin-right: 10px;">取消</a>
                <button type="submit" class="btn btn-success">保存文章</button>
            </div>
        </form>
    </div>

    <script>
        // Pass server-side variables to client-side
        const articleId = "<%- article.id || '' %>";
        const isEdit = !!articleId;

        var simplemde = new SimpleMDE({ 
            element: document.getElementById("markdown-editor"),
            placeholder: "在这里输入正文内容...",
            spellChecker: false,
            autosave: {
                enabled: isEdit,
                uniqueId: "article-editor-" + (articleId || 'new'),
                delay: 1000,
            },
            status: ["autosave", "lines", "words", "cursor"],
        });

        // If it's a new article, ensure the editor is empty regardless of autosave
        if (!isEdit) {
            if (simplemde.value() && !document.getElementById("markdown-editor").value) {
                simplemde.value("");
            }
        }

        // Handle image paste
        simplemde.codemirror.on("paste", function(cm, e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    e.preventDefault();
                    const file = items[i].getAsFile();
                    uploadImage(file);
                }
            }
        });

        function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            // Insert placeholder
            const pos = simplemde.codemirror.getCursor();
            const placeholder = "![正在上传图片...]()";
            simplemde.codemirror.replaceRange(placeholder, pos);
            
            fetch('/admin/upload-image', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const newText = `![图片](${data.url})`;
                    const endPos = { line: pos.line, ch: pos.ch + placeholder.length };
                    simplemde.codemirror.replaceRange(newText, pos, endPos);
                } else {
                    alert('图片上传失败: ' + (data.message || '未知错误'));
                    // Remove placeholder on failure
                    const endPos = { line: pos.line, ch: pos.ch + placeholder.length };
                    simplemde.codemirror.replaceRange('', pos, endPos);
                }
            })
            .catch(err => {
                console.error('Error uploading image:', err);
                alert('图片上传出错');
                // Remove placeholder on error
                const endPos = { line: pos.line, ch: pos.ch + placeholder.length };
                simplemde.codemirror.replaceRange('', pos, endPos);
            });
        }
    </script>
</body>
</html>